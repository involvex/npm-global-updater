name: ğŸš€ NPM Global Updater Release

# Enhanced workflow for npm-global-updater package releases
# Features: Caching, validation, error handling, security, and performance optimization

permissions:
  contents: write
  discussions: write
  id-token: write # For trusted publishing
  pull-requests: write # For automated changelog PRs

# Environment variables for consistent configuration
env:
  NODE_VERSION: "20"
  BUN_VERSION: "1.3.5"
  DEFAULT_BRANCH: "main"
  WORKING_DIRECTORY: ${{ github.workspace }}

# Trigger configuration
on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g., 1.0.0) - leave empty for auto-detection"
        required: false
        type: string
      release_type:
        description: "Release type for auto-versioning"
        required: false
        type: choice
        default: "auto"
        options:
          - auto
          - patch
          - minor
          - major
          - prerelease
      dry_run:
        description: "Perform a dry run without making actual changes"
        required: false
        type: boolean
        default: false
      force_release:
        description: "Force release even with validation warnings"
        required: false
        type: boolean
        default: false
      create_draft:
        description: "Create release as draft"
        required: false
        type: boolean
        default: true
  push:
    branches:
      - main
      - develop
    tags:
      - "v*.*.*" # Only trigger on version tags

# Job definitions with proper separation of concerns
jobs:
  # Pre-validation job to check prerequisites
  validate:
    name: âœ… Prerequisites Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      should_release: ${{ steps.validation.outputs.should_release }}
      version: ${{ steps.validation.outputs.version }}
      release_notes: ${{ steps.validation.outputs.release_notes }}
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for changelog generation

      - name: ğŸ” Validate repository state
        id: validation
        run: |
          echo "ğŸ” Validating repository state..."

          # Check for uncommitted changes
          if [ -n "$(git status --porcelain)" ]; then
            echo "âŒ Uncommitted changes detected"
            if [ "${{ github.event.inputs.force_release }}" != "true" ]; then
              echo "::error::Uncommitted changes found. Commit changes or use force_release=true"
              exit 1
            fi
            echo "âš ï¸  Continuing due to force_release=true"
          fi

          # Validate version input if provided
          VERSION="${{ github.event.inputs.version }}"
          if [ -n "$VERSION" ]; then
            if ! echo "$VERSION" | grep -E '^v?\d+\.\d+\.\d+(-[a-zA-Z0-9.-]+)?$'; then
              echo "::error::Invalid version format: $VERSION"
              echo "Expected format: 1.0.0, 1.0.0-alpha.1, v1.0.0"
              exit 1
            fi
            # Normalize version (remove 'v' prefix if present)
            VERSION=$(echo "$VERSION" | sed 's/^v//')
            echo "âœ… Version validated: $VERSION"
          else
            # Auto-detect version from package.json
            VERSION=$(node -p "require('./package.json').version")
            echo "âœ… Auto-detected version: $VERSION"
          fi

          echo "should_release=true" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # Generate release notes if not provided
          if [ -f "CHANGELOG.md" ]; then
            echo "ğŸ“ Extracting release notes from CHANGELOG.md..."
            # Extract the most recent version's changelog
            RELEASE_NOTES=$(awk "/^## v?$VERSION/,/^## v?[0-9]/ {print}" CHANGELOG.md | head -n -1)
            echo "$RELEASE_NOTES" > release_notes.txt
          else
            echo "ğŸ“ Generating basic release notes..."
            echo "Release $VERSION" > release_notes.txt
          fi

          echo "release_notes<<EOF" >> $GITHUB_OUTPUT
          cat release_notes.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  # Build job with caching and parallel execution
  build:
    name: ğŸ”¨ Build & Test
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.should_release == 'true'
    timeout-minutes: 15
    strategy:
      matrix:
        node-version: [22]
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ§  Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"

      - name: ğŸ“¦ Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: ğŸ’¾ Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: ğŸ“‹ Install dependencies
        run: bun install --frozen-lockfile

      - name: ğŸ” Lint code
        run: bun run lint

      - name: âœ… Type check
        run: bun run typecheck

      - name: ğŸ§ª Run tests (if available)
        run: bun test

      - name: ğŸ—ï¸ Build JavaScript bundle
        run: bun run build

      - name: ğŸ—ï¸ Build Portable Executable
        run: bun run build:porteable

      - name: ğŸ“„ Generate changelog
        run: |
          if command -v changelogen &> /dev/null; then
            bun run changelog
          else
            echo "â„¹ï¸  changelogen not available, skipping changelog generation"
          fi

      - name: ğŸ“‹ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts-${{ needs.validate.outputs.version }}
          path: |
            bin/
            CHANGELOG.md
          retention-days: 30

      - name: ğŸ“‹ Upload build logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ needs.validate.outputs.version }}
          path: |
            bun-debug.log
            npm-debug.log*
          retention-days: 7

  # Release job with enhanced error handling
  release:
    name: ğŸ‰ Create Release
    runs-on: ubuntu-latest
    needs: [validate, build]
    if: needs.validate.outputs.should_release == 'true'
    timeout-minutes: 10
    environment: release
    outputs:
      new_version: ${{ steps.version_bump.outputs.new_version }}
    steps:
      - name: ğŸ“¥ Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts-${{ needs.validate.outputs.version }}
          path: ./release-files

      - name: ğŸ“¥ Checkout repository (for git operations)
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: âš™ï¸ Configure Git identity
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          echo "âœ… Git user configured for automated commits"
      - name: install bun global
        run: npm i -g bun    

      - name: ğŸ“ˆ Increase Version
        run: |
          echo "ğŸ”„ Determining version bump type..."

          RELEASE_TYPE="${{ github.event.inputs.release_type }}"
          if [ -z "$RELEASE_TYPE" ] || [ "$RELEASE_TYPE" = "auto" ]; then
            RELEASE_TYPE="patch"
            echo "â„¹ï¸  Using default patch release"
          fi

          echo "ğŸ“¦ Bumping version: $RELEASE_TYPE"

          # Get current version
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "ğŸ“‹ Current version: $CURRENT_VERSION"

          # Use npm version without running post scripts to avoid bun dependency
          if npm version "$RELEASE_TYPE" --no-git-tag-version --no-commit-hooks; then
            echo "âœ… Version bumped successfully"
            # Get the new version
            NEW_VERSION=$(node -p "require('./package.json').version")
            echo "ğŸ“‹ New version: $NEW_VERSION"
            echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
            
            # Create and commit the version change
            git add package.json package-lock.json
            git commit -m "chore: bump version to $NEW_VERSION"
            echo "âœ… Version commit created"
            
            # Push the commit
            git push origin main
            echo "âœ… Version commit pushed to repository"
          else
            echo "âŒ Failed to bump version"
            exit 1
          fi
        id: version_bump

      - name: ğŸ·ï¸ Create and push tag
        run: |
          VERSION="${{ steps.version_bump.outputs.new_version }}"
          TAG_NAME="v$VERSION"

          echo "ğŸ·ï¸  Creating tag: $TAG_NAME"

          # Create annotated tag with release notes
          if [ -f "release_notes.txt" ]; then
            git tag -a "$TAG_NAME" -F release_notes.txt
          else
            git tag -a "$TAG_NAME" -m "Release $VERSION"
          fi

          # Push tag to repository
          git push origin "$TAG_NAME"

          echo "âœ… Tag $TAG_NAME pushed successfully"

      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version_bump.outputs.new_version }}
          name: Release v${{ steps.version_bump.outputs.new_version }}
          body: ${{ needs.validate.outputs.release_notes }}
          body_path: release_notes.txt
          draft: ${{ github.event.inputs.create_draft }}
          prerelease: ${{ contains(steps.version_bump.outputs.new_version, '-') }}
          make_latest: true
          generate_release_notes: true
          files: |
            ./release-files/bin/npm-updater.js
            ./release-files/bin/npm-updater.exe
            ./release-files/CHANGELOG.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“Š Update release statistics
        run: |
          VERSION="${{ steps.version_bump.outputs.new_version }}"
          echo "ğŸ“ˆ Release v$VERSION completed successfully"
          echo "ğŸ¯ Release URL: https://github.com/${{ github.repository }}/releases/tag/v$VERSION"

      - name: ğŸ”” Notify success (optional)
        if: success() && github.event.inputs.dry_run != 'true'
        run: |
          echo "ğŸ‰ Release v${{ steps.version_bump.outputs.new_version }} completed successfully!"
          echo "ğŸ“¦ Release URL: https://github.com/${{ github.repository }}/releases/tag/v${{ steps.version_bump.outputs.new_version }}"

  # Cleanup job for failed releases
  cleanup:
    name: ğŸ§¹ Cleanup on Failure
    runs-on: ubuntu-latest
    needs: [validate, build, release]
    if: failure()
    timeout-minutes: 5
    steps:
      - name: ğŸ“¥ Download artifacts
        uses: actions/download-artifact@v4
        if: always()
        with:
          path: ./failed-release-artifacts

      - name: ğŸ“ Log failure details
        run: |
          echo "ğŸ’¥ Release process failed"
          echo "ğŸ” Check the logs above for details"
          echo "ğŸ“‹ Failed artifacts (if any) are available for debugging"

      - name: ğŸ”” Notify failure
        run: |
          echo "âŒ Release failed"
          echo "ğŸš¨ Please check the workflow logs for troubleshooting"
          echo "ğŸ”— Workflow URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
